<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    

    <title>GN 论文总结 | tech.radish</title>
    <meta name="author" content="yang.tang">
    
    <meta name="description" content="GN(Group Normalization)解决了在Batch Size太小时BN失效的问题。总结如下：">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="GN 论文总结">
    <meta property="og:site_name" content="tech.radish">

    
    <meta property="og:image" content>
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="tech.radish" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/prettify-tomorrow-night-eighties.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>
</html>

<body>
    <img src="/weixin_favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

    <nav class="indigo">
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class>
            <a href="/" class="brand-logo hide-on-med-and-down">tech.radish</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " href="/">
                            <i class="fa fa-home "></i>
                            
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " href="/archives">
                            <i class="fa fa-archive "></i>
                            
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" href="javascript:;" data-activates="category-menu">
                            <i class="fa fa-bookmark "></i>
                            
                            分类
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-reading " href="/reading">
                            <i class="fa fa-book "></i>
                            
                            读书
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-about " href="/about">
                            <i class="fa fa-user "></i>
                            
                            关于
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-search modal-trigger " href="#search">
                            <i class="fa fa-search "></i>
                            
                            搜索
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav indigo darken-1" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="https://mic-jasontang.github.io/imgs/avatar.jpg" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">tech.radish</p>
                        <p class="desc">python/Java/ML/CV</p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/">
                    <i class="fa fa-home "></i>
                    
                    首页
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives">
                    <i class="fa fa-archive "></i>
                    
                    归档
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu">
                    <i class="fa fa-bookmark "></i>
                    
                    分类
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-reading " href="/reading">
                    <i class="fa fa-book "></i>
                    
                    读书
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-about " href="/about">
                    <i class="fa fa-user "></i>
                    
                    关于
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-search modal-trigger " href="#search">
                    <i class="fa fa-search "></i>
                    
                    搜索
                </a>
            </li>
        
    </ul>

    <ul class="side-nav indigo darken-1" id="category-menu">
    

            

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/数学基础/">
                    数学基础 <span class="right">1 篇</span></a>
                
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/数学基础/随机过程/">
                    随机过程 <span class="right">1 篇</span></a>
                
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/基础算法/">
                    基础算法 <span class="right">2 篇</span></a>
                
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/基础算法/树/">
                    树 <span class="right">1 篇</span></a>
                
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/基础算法/字符串/">
                    字符串 <span class="right">1 篇</span></a>
                
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/技术文章/">
                    技术文章 <span class="right">1 篇</span></a>
                
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/技术文章/博客搭建/">
                    博客搭建 <span class="right">1 篇</span></a>
                
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/图像处理/">
                    图像处理 <span class="right">2 篇</span></a>
                
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/图像处理/图像增强/">
                    图像增强 <span class="right">2 篇</span></a>
                
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/周总结/">
                    周总结 <span class="right">7 篇</span></a>
                
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/研磨-粗糙度/">
                    研磨-粗糙度 <span class="right">1 篇</span></a>
                
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/研磨-粗糙度/研磨表面仿真/">
                    研磨表面仿真 <span class="right">1 篇</span></a>
                
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/tensorflow学习/">
                    tensorflow学习 <span class="right">1 篇</span></a>
                
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/tensorflow学习/tensorflow-Demo/">
                    tensorflow-Demo <span class="right">1 篇</span></a>
                
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/深度学习/">
                    深度学习 <span class="right">1 篇</span></a>
                
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/深度学习/深度学习基础/">
                    深度学习基础 <span class="right">1 篇</span></a>
                
            </li>

        

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">搜索</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


    <main>
        <div class="container main-container">
    <nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper indigo">
        <span class="breadcrumb">当前位置（分类目录）</span>
        
            
    
    
    <a class="breadcrumb" href="/categories/周总结/">周总结</a>


        

        
    </div>
</nav>

<article>
    <div class="card">
        <div class="card-content">
            

            <div class="article-title">
                
    
        <h1>GN 论文总结</h1>
    


            </div>
            <div style="margin-top:10px;">
    <span class="post-time">
      <i class="fa fa-calendar"></i>
      <time class="green-link-context" datetime="2019-04-28T03:11:00.000Z"><a href="/2019/04/28/第 5 周学习分享/">2019-04-28</a></time>

      &nbsp; | &nbsp;
    </span>

    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <span class="post-count">748字</span>
      </span>
    </span>

    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">  阅读时长: </span>
        <span class="post-count">3分</span>
      </span>
    </span>
    
      <span class="post-time">
        <div style="float: right;color: #E91E63"> 
          阅读次数: <span id="busuanzi_value_page_pv"></span>
        </div>
        <span id="busuanzi_container_page_pv" class="read-times-container">
    <span id="busuanzi_value_page_pv"></span>
</span>

      </span>
    
</div>
            
    <div class="tags-row">
        
            <a href="/tags/deep-learning/" class="chip pink lighten-1">deep learning</a>
        
            <a href="/tags/GN/" class="chip pink lighten-1">GN</a>
        
    </div>


            <div class="toc green-link-context hide-on-med-and-down">
    <ol class="section table-of-contents"><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#唐洋的学习心得"><span class="section table-of-contents-text">唐洋的学习心得</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-5"><a class="section table-of-contents-link" href="#1-BN的优点"><span class="section table-of-contents-text">1. BN的优点</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#2-BN的缺点"><span class="section table-of-contents-text">2. BN的缺点</span></a></li><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#3-GN"><span class="section table-of-contents-text">3. GN</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-5"><a class="section table-of-contents-link" href="#3-1-如何划分groups？"><span class="section table-of-contents-text">3.1 如何划分groups？</span></a></li><li class="section table-of-contents-item section table-of-contents-level-5"><a class="section table-of-contents-link" href="#3-2-代码实现-tf"><span class="section table-of-contents-text">3.2 代码实现(tf)</span></a></li></ol></li></ol>
</div>


            <div class="entry green-link-context">
                <p>GN(Group Normalization)解决了在Batch Size太小时BN失效的问题。总结如下：</p>
<a id="more"></a>
<h3 id="唐洋的学习心得"><a href="#唐洋的学习心得" class="headerlink" title="唐洋的学习心得"></a>唐洋的学习心得</h3><p>介绍GN之前，先回顾下BN。</p>
<h5 id="1-BN的优点"><a href="#1-BN的优点" class="headerlink" title="1. BN的优点"></a>1. BN的优点</h5><ul>
<li>BN可以使网络中每层输入数据的分布相对稳定，加速模型的学习速度</li>
<li>BN可以使模型对网络中的参数不那么敏感，简化调参过程，使得网络学习更加稳定</li>
<li>BN可以允许网络使用饱和性激活函数（sigmoid &amp; tanh），缓解梯度消失问题</li>
<li>BN具有一定的正则化效果</li>
</ul>
<h4 id="2-BN的缺点"><a href="#2-BN的缺点" class="headerlink" title="2. BN的缺点"></a>2. BN的缺点</h4><p>先不管它应用在什么任务（像素级图片生成）或网络（RNN）上面会有缺陷。</p>
<ul>
<li>对于限制了Batch Size的任务来说，BN会失效</li>
<li>对于训练时计算的均值和方差，在验证和测试的时候并不适用（如果训练、验证、测试集的分布不同）</li>
</ul>
<h4 id="3-GN"><a href="#3-GN" class="headerlink" title="3. GN"></a>3. GN</h4><p>GN <a href="https://arxiv.org/pdf/1803.08494.pdf" target="_blank" rel="noopener">here</a> 抛弃了对Batch Size大小的依赖，是BN的一种替代方法。</p>
<p>Group的思想来自于：AlexNet的group convolutions，MobileNet &amp; Xception 的channel-wise convolutions, ShuffleNet的channle shuffle operation，SIFT、HOG的group wise 金字塔等。</p>
<p><img src="https://github.com/facebookresearch/Detectron/blob/master/projects/GN/gn.jpg" alt="GN示意图"></p>
<p><strong>Normalization methods</strong>. Each subplot shows a feature map tensor, with N as the batch axis, C as the channel axis, and (H, W) as the spatial axes. The pixels in blue are normalized by the same mean and variance, computed by aggregating the values of these pixels. In rightmost figure, which is a simple case of 2 groups (G = 2) each having 3 channels.</p>
<p><strong>主要步骤</strong>：首先将Channels划分为多个groups，再计算每个group内的均值μ和方差σ，以进行归一化。</p>
<h5 id="3-1-如何划分groups？"><a href="#3-1-如何划分groups？" class="headerlink" title="3.1 如何划分groups？"></a>3.1 如何划分groups？</h5><p>也就是我上周总结中提到的几何S如何确定。</p>
<p><strong>首先在2D图像中，使用4D向量来表示,(N,C,H,W),N表示batch axis, C表示channel axis,H &amp; W表示height &amp; width axis</strong>.</p>
<ul>
<li>BN是在同一个C axis上进行，即计算μ和σ是在（N, H, W）axes.</li>
<li>LN (layer)是在同一个N axis上进行，即计算μ和σ是在(C, H, W) axes.</li>
<li>IN (Instance)是在同一个N axis和C axis上进行，即计算μ和σ是在(H,W) axes.</li>
<li>GN也是在同一个N axis 和C axis上进行，计算μ和σ是在(H,W) axes和C/G channels.</li>
</ul>
<p>GN计算公式是原文的公式1（也是其他几种Normalization的方法的计算公式，只是集合S的确定方式不同），其中μ和σ如原文公式2所示，确定集合S的公式如公式7所示。</p>
<p>GN公式中(原文公式7)，G表示分组数量（默认32），C/G表示每组的通道数量，计算示意图如上图中的最右边，例子中G=2，每组的channels=3.</p>
<h5 id="3-2-代码实现-tf"><a href="#3-2-代码实现-tf" class="headerlink" title="3.2 代码实现(tf)"></a>3.2 代码实现(tf)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">def GroupNorm(x, gamma, beta, G, eps=1e-5):</span><br><span class="line">	# x: input features with shape [N, C, H, W]</span><br><span class="line">	# gamma: beta: scale and offset, with shape [1, C, 1, 1]</span><br><span class="line">	# G: number of groups for GN</span><br><span class="line">	N, G, H, W = x.shape</span><br><span class="line">	x = tf.reshape(x, [N, G, C//G, H, W])</span><br><span class="line">	</span><br><span class="line">	# [2,3,4]表示 G,H,W axes</span><br><span class="line">	mean, var = tf.nn.moments(x, [2,3,4], keep_dim=True)</span><br><span class="line">	x = (x - mean) / tf.sqrt(var + eps)</span><br><span class="line">	</span><br><span class="line">	x = tf.reshape(x, [N, C, H, W])</span><br><span class="line">	</span><br><span class="line">	return x * gamma + beta</span><br></pre></td></tr></table></figure>

                
<p class="green-link-context">
    <a href="/2019/05/04/第 6 周学习分享/" rel="next" title="FCN 论文总结">
    上一篇：FCN 论文总结
  </a>
</p>



<p class="green-link-context">
    <a href="/2019/04/20/第 4 周学习分享/" rel="next" title="深度学习中的Normalization模型">
    下一篇：深度学习中的Normalization模型
  </a>
</p>


            </div>
			
        </div>
    </div>
</article>








	<!-- 来必力City版安装代码 -->
<div id="lv-container" data-id="city" data-uid="MTAyMC8zNTAzNy8xMTU3Mw==">
	<script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
	</script>
<noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
</div>
<!-- City版安装代码已完成 -->





</div>

        <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large green">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect blue" title="回到顶部"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse orange" data-activates="main-menu" title="菜单"><i class="fa fa-navicon"></i></a></li>
    </ul>
  </div>

    </main>
    <footer class="page-footer indigo darken-1">
    
    <div class="footer-container container">
        <div class="row">
            
            <div class="social-group col m4 s12">
                <h5 class="white-text">社交</h5>
                
                    <a class="social-link" href="https://github.com/mic-jasontang" target="_blank">
                        <i class="fa fa-2x fa-github"></i>
                    </a>
                
                    <a class="social-link" href="mailto:sunshinetown16@gmail.com" target="_blank">
                        <i class="fa fa-2x fa-envelope"></i>
                    </a>
                
            </div>
            

            
            <div class="col m4 s12">
                <h5 class="white-text">友情链接</h5>
                
                    <a class="social-link" href="https://github.com/mic-jasontang" target="_blank">Github</a>
                
                    <a class="social-link" href="https://blog.csdn.net/q361239731" target="_blank">CSDN博客</a>
                
            </div>
            

            <div class="col m4 s12">
                <h5 class="white-text">访问次数</h5>
                
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
    </script>
    <div class="site-visitors-container white-text">
        <span>
            <i class="fa fa-user"></i>
            <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
        </span> 
        <span>&nbsp;|&nbsp;</span>
        <span>
            <i class="fa fa-eye"></i>
            <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
        </span>
    </div>


                <span class="white-text"> <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> </span>
            </div>
        </div>
    </div>
    
    
    <script>
        var now = new Date(); 
        function createtime() { 
            var grt= new Date("03/19/2018 12:00:00");
            now.setTime(now.getTime()+250); 
            days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
            hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
            if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
            mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
            seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
            snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
            document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 "; 
            document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
        } 
        setInterval("createtime()",250);
    </script>
    <div class="footer-copyright green-link-context">
        <div class="container">
            © 2019 tech.radish <i class="fa fa fa-heart"></i>
            <p class="right" style="margin-top: 0;">本博客由 <a href="https://hexo.io"><span style="color:#fff">Hexo</span></a> 强力驱动</p>
        </div>
    </div>
    
</footer>



    <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


	<script src="/js/love.js"></script>
	<script src="/js/float.js"></script>
	<script src="/js/typewriter.js"></script>
	<script color="0,104,183" opacity="1" zindex="-1" count="50" src="/js/particle.js"></script>


<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();

            // 目录随屏幕滚动（防止目录过长越过footer）
            var $toc = $('.toc');
            var scrollTargetTop = 0;
            $(window).scroll(function() {
                var $activeLink = $toc.find('a.active.section');
                if ($(window).scrollTop() < 100) {
                    scrollTargetTop = 0;
                } else {
                    if ($activeLink[0]) {
                        scrollTargetTop = $activeLink.offset().top - $toc.offset().top;
                    }
                }
                $toc.css('top', '-' + scrollTargetTop + 'px');
            });

            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass('green lighten-2');

            
            // 添加new标签
            $('.menu-reading').append('<span class="new badge pink"></span>');
            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "search.xml";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword green lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword green lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>







    
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
</script>
<script type="text/javascript" async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>



</body>
</html>
